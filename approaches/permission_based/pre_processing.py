import csv
import os
import re
from collections import Counter, defaultdict

import pandas as pd

from androguard.misc import APK
from utils import constants
import androguard_helper

apks_folder = '/home/mkr/Desktop/projects/python/databases/cic_and_mal_2017/subtrain_apks'
apk_files = []
for root, class_dirs, _ in os.walk(apks_folder):
    for class_dir in class_dirs:
        for r, _, files in os.walk(os.path.join(root, apks_folder)):
            for f in files:
                if f.endswith('.apk'):
                    apk_path = os.path.join(root, class_dir, f)
                    apk_files.append(apk_path)

subtrain = pd.read_csv(constants.CSV_SUBTRAIN)
malware_classes = pd.read_csv(constants.CSV_CLASSES)
ifs_map = defaultdict(Counter)

count = 0
intent_filters_list = []
for row in subtrain.get_values():
    malware_class_name = malware_classes[malware_classes.ClassId == row[1]].ClassName.get_values()[0]
    filename = os.path.join(apks_folder, malware_class_name, row[0] + ".apk")
    print 'Apk: %s' % filename
    intent_filters = []
    for intent_filter in androguard_helper.get_all_intent_filters(APK(filename)):
        if str(intent_filter).count('.') >= 2:
            intent_filters.append(intent_filter)
    ifs_map[row[0]] = Counter(intent_filters)
    intent_filters_list.extend(intent_filters)

intent_filters_keys = list(Counter(intent_filters_list).keys())

cc = Counter([])
for d in ifs_map.values():
    cc += d
selectedfeatures = {}
tc = 0
for k, v in cc.iteritems():
    selectedfeatures[k] = v
    print k, v
    tc += 1
dataframelist = []
for fid, op3gram in ifs_map.iteritems():
    standard = {"Id": fid}
    for feature in selectedfeatures:
        if feature in op3gram:
            standard[feature] = op3gram[feature]
        else:
            standard[feature] = 0
    dataframelist.append(standard)

df = pd.DataFrame(dataframelist)
df.to_csv(constants.CSV_FEATURES_INTENTS, index=False)
