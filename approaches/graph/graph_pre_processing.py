import json
import os
import shutil
import time

import matplotlib.pyplot as plt
import networkx as nx
import pandas as pd

from approaches.graph.graph_utils import graph_utils
from androguard.misc import AnalyzeAPK
from approaches.graph.graph_utils.GraphObject import GraphObject
from utils import constants

files_path = constants.FOLDER_ROOT + '/approaches/graph/train'


def create_and_save_graph(path_to_apk, path_to_save):
    print '-------------------------------------------------------------------------------------'
    start_time = time.time()
    print '[%s]: Size: %s' % (os.path.basename(path_to_apk), os.path.getsize(path_to_apk) / 1000)
    print '[%s]: Analyzing...' % os.path.basename(path_to_apk)
    a, d, dx = AnalyzeAPK(path_to_apk)
    # print a.show()
    print '[%s]: Creating graph...' % os.path.basename(path_to_apk)
    CFG, op_count = graph_utils.get_graph(a, d, dx)
    # nx.write_gml(CFG)
    print '[%s]: Operation count = %s' % (os.path.basename(path_to_apk), op_count)
    save_graph(CFG, path_to_save)
    print '[%s]: Saved to %s' % (os.path.basename(path_to_apk), path_to_save)
    print '[%s]: Duration - %s sec.' % (os.path.basename(path_to_apk), time.time() - start_time)


def graph_it(path_to_apk):
    a, d, dx = AnalyzeAPK(path_to_apk)
    CFG, op_count = graph_utils.get_graph(a, d, dx)
    plt.figure(figsize=(15, 15))
    nx.draw_networkx(CFG, with_labels=True, font_size=8, width=0.1, font_color='green')
    plt.draw()
    plt.show()


def read_and_show_graph(path_to_graph):
    CFG = nx.DiGraph(nx.read_gml(path_to_graph))
    plt.figure(figsize=(10, 10))
    nx.draw_networkx(CFG, with_labels=True, font_size=14, width=1)
    plt.draw()
    plt.show()


def save_graph(graph, filename):
    edges = []
    nodes = []
    for edge in graph.edges:
        item = dict()
        item['source'] = edge[0]
        item['target'] = edge[1]
        edges.append(item)

    for node in graph.nodes:
        nodes.append(node)

    obj = GraphObject(edges=edges, nodes=nodes)
    with open(filename, 'w') as outfile:
        json.dump(obj.get_dict(), outfile)


def prepare_train_folder():
    def clear():
        for path, dirs, files in os.walk(files_path):
            for d in dirs:
                shutil.rmtree('%s/%s' % (files_path, d))
            for f in files:
                os.remove('%s/%s' % (files_path, f))
        print 'Classes folder were cleared'

    def create_class_folders():
        malware_classes = pd.read_csv(constants.CSV_CLASSES)
        for className in malware_classes.ClassName:
            os.mkdir('%s/%s' % (files_path, className))
        print 'Classes folders were created'

    clear()
    create_class_folders()


def extract_all_graphs():
    subtrains = pd.read_csv(constants.CSV_SUBTRAIN)
    malware_classes = pd.read_csv(constants.CSV_CLASSES)
    apks_root_target = '/home/mkr/Desktop/projects/python/databases/cic_and_mal_2017/subtrain_apks'
    ids = []
    for item in subtrains.Id:
        ids.append(item)

    for id in ids:
        id_class = subtrains[subtrains.Id == id].Class.get_values()[0]
        id_class_name = malware_classes[malware_classes.ClassId == id_class].ClassName.get_values()[0]
        apk_path_src = '%s/%s/%s.apk' % (apks_root_target, id_class_name, id)
        save_path_src = '%s/%s/%s.json' % (files_path, id_class_name, id)
        if os.path.getsize(apk_path_src) / 1000000 <= 3:
            if not os.path.exists(save_path_src):
                create_and_save_graph(path_to_apk=apk_path_src, path_to_save=save_path_src)
            else:
                print '[%s]: Skipping' % os.path.basename(save_path_src)


if __name__ == '__main__':
    # create_and_save_graph(path_to_apk="/home/mkr/Desktop/projects/python/databases/cic_and_mal_2017/train/Adware/5dc565a01bb789d8d171c20f52ac34c8.apk",
    #                       path_to_save="asd.json")
    # print hashlib.md5("SERVICEjava.net.URL").hexdigest()
    # graph_it("/home/mkr/Desktop/projects/python/databases/cic_and_mal_2017/train/Adware/5dc565a01bb789d8d171c20f52ac34c8.apk")
    # read_and_show_graph("1634b1fb3b353019e9d3b7b3d21507ab.graph")

    # prepare_train_folder()
    extract_all_graphs()
