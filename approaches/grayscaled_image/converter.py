import os
from scipy.misc import imsave
import array
import numpy as np
import shutil
import pandas as pd
from utils import constants


# Create folders from classes.csv
def prepare_imgs_folder():
    imgs_path = constants.FOLDER_ROOT + '/approaches/grayscaled_image/imgs'

    def clear():
        for path, dirs, files in os.walk(imgs_path):
            for d in dirs:
                shutil.rmtree('%s/%s' % (imgs_path, d))
            for f in files:
                os.remove('%s/%s' % (imgs_path, f))
        print 'Image folder was cleared'

    def create_class_folders():
        malware_classes = pd.read_csv(constants.CSV_CLASSES)
        for className in malware_classes.ClassName:
            os.mkdir('%s/%s' % (imgs_path, className))
        print 'Classes folders were created'

    clear()
    create_class_folders()


def convert_file_to_png(file_path):
    f = open(file_path, 'rb')
    filename = os.path.basename(file_path)
    ln = os.path.getsize(file_path)
    width = 256
    rem = ln % width

    a = array.array("B")
    a.fromfile(f, ln - rem)

    f.close()

    g = np.reshape(a, (len(a) / width, width))
    g = np.uint8(g)

    imsave('imgs/%s.png' % filename, g)


apk_file_location = '/home/mkr/Desktop/projects/python/databases/cic_and_mal_2017/sms_1331ae4b33daabf7ac0462cf03babf6a.apk'
# prepare_imgs_folder()
convert_file_to_png(apk_file_location)
