import csv
import os

import pandas as pd

data_path = '/home/mkr/Desktop/projects/python/databases/cic_and_mal_2017/train_opseq'


def divider_str():
    print '-----------------------'


def get_apks_fullpathes():
    malware_classes_names = []
    for (dirpath, dirnames, filenames) in os.walk(data_path):
        malware_classes_names.extend(dirnames)
        break

    malware_classes_apks_paths = []

    for malware_class_name in malware_classes_names:
        malware_class_path = '%s/%s' % (data_path, malware_class_name)
        class_apks = []
        for (dirpath, dirnames, filenames) in os.walk(malware_class_path):
            for filename in filenames:
                apk_path = '%s/%s' % (malware_class_path, filename)
                class_apks.append(apk_path)
        malware_classes_apks_paths.append(class_apks)
    return malware_classes_apks_paths


def create_malware_classes_csv():
    with open('classes.csv', 'wb') as csvfile:
        filewriter = csv.writer(csvfile, delimiter=',', quotechar='|', quoting=csv.QUOTE_MINIMAL)
        filewriter.writerow(['ClassId', 'ClassName'])
        class_id = 0
        for (dirpath, dirnames, filenames) in os.walk(data_path):
            for dirname in dirnames:
                class_id += 1
                filewriter.writerow([class_id, dirname])


# Use it ONLY if your apk files separated in theirs category folders
def create_csv():
    divider_str()

    create_malware_classes_csv()
    malware_classes = pd.read_csv('classes.csv')

    with open('trainLabels.csv', 'wb') as csvfile:
        filewriter = csv.writer(csvfile, delimiter=',', quotechar='|', quoting=csv.QUOTE_MINIMAL)
        filewriter.writerow(['Id', 'Class'])

        for class_apks_path in get_apks_fullpathes():
            for apk_path in class_apks_path:
                apk_name = os.path.basename(apk_path)
                malware_class = apk_path.replace(data_path, '').replace(apk_name, '').replace('/', '')
                malware_class_id = malware_classes[malware_classes.ClassName == malware_class].ClassId.get_values()[0]
                print apk_name
                filewriter.writerow([apk_name.replace('.opseq', ''), malware_class_id])


create_csv()
