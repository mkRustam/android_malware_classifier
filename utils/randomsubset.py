import os
from random import *
import pandas as pd
import shutil
from utils import constants

rs = Random()
rs.seed(1)

trainlabels = pd.read_csv(constants.CSV_TRAIN)
fids = []
opd = pd.DataFrame()
malware_classes = 4

# maximum available samples per class (min samples count of all class)
max_available_sample = 100000
for clabel in range(1, malware_classes + 1):
    class_sample = len(trainlabels[trainlabels.Class == clabel])
    if max_available_sample > class_sample:
        max_available_sample = class_sample

for clabel in range(1, malware_classes + 1):
    mids = trainlabels[trainlabels.Class == clabel]
    mids = mids.reset_index(drop=True)

    rchoice = list(range(0, max_available_sample, 1))

    #     for i in rchoice:
    #         fids.append(mids.loc[i].Id)
    #         opd = opd.append(mids.loc[i])

    rids = [mids.loc[i].Id for i in rchoice]
    fids.extend(rids)
    opd = opd.append(mids.loc[rchoice])

opd = opd.reset_index(drop=True)
# print opd
opd.to_csv(constants.CSV_SUBTRAIN, encoding='utf-8', index=False)

sbase = '/home/mkr/Desktop/projects/python/databases/cic_and_mal_2017/train_opseq/'
tbase = '/home/mkr/Desktop/projects/python/databases/cic_and_mal_2017/subtrain/'
malware_classes = pd.read_csv(constants.CSV_CLASSES)

# creating malware classes folders in tbase
for mal_class in malware_classes['ClassName'].get_values():
    dir_path = tbase + mal_class
    if not os.path.isdir(dir_path):
        os.mkdir(dir_path)

for row in opd.get_values():
    opseq_filename = row[0]
    print opseq_filename + ' In process...'
    malware_class_name = malware_classes[malware_classes.ClassId == row[1]].ClassName.get_values()[0]
    opseq_path_src = os.path.join(sbase, '%s/%s.opseq' % (malware_class_name, opseq_filename))
    opseq_path_target = os.path.join(tbase, '%s/%s.opseq' % (malware_class_name, opseq_filename))
    shutil.copy(opseq_path_src, opseq_path_target)

# Move subtrain's APKs to subtrain_apks folder
subtrains = pd.read_csv(constants.CSV_SUBTRAIN)
malware_classes = pd.read_csv(constants.CSV_CLASSES)
apks_root_src = '/home/mkr/Desktop/projects/python/databases/cic_and_mal_2017/Dataset'
apks_root_target = '/home/mkr/Desktop/projects/python/databases/cic_and_mal_2017/subtrain_apks'

ids = []
for item in subtrains.Id:
    ids.append(item)

for id in ids:
    id_class = subtrains[subtrains.Id == id].Class.get_values()[0]
    id_class_name = malware_classes[malware_classes.ClassId == id_class].ClassName.get_values()[0]
    apk_path_src = '%s/%s/%s.apk' % (apks_root_src, id_class_name, id)
    apk_path_target = '%s/%s/%s.apk' % (apks_root_target, id_class_name, id)
    print apk_path_target
    shutil.move(apk_path_src, apk_path_target)
