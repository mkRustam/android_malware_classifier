#!/usr/bin/env python
import sys
import os
from utils import opcode_sequence

sys.path.insert(1, os.path.join(sys.path[0], '../..'))


def main2():
    apks = []
    inv_limit = 1000
    rec_depth = 5
    apk_file_directory = '/home/mkr/Desktop/projects/python/databases/cic_and_mal_2017/train/'
    for malware_class_name in os.listdir(apk_file_directory):
        malware_class_folder = os.path.join(apk_file_directory, malware_class_name)
        for apk_file in os.listdir(malware_class_folder):
            apks.append('%s/%s' % (malware_class_folder, apk_file))

    for apk_hash in apks:
        apk_file_location = os.path.join(apk_file_directory, apk_hash)
        opcode_file_path = '%s/%s' % (
            os.path.dirname(apk_file_location), os.path.basename(apk_file_location).replace('.apk', '.opseq')
        )

        if not os.path.isfile(opcode_file_path):
            try:
                opcodes = opcode_sequence.get_seq_extraction(apk_file_location, inv_limit, rec_depth)
                if opcodes is not None:
                    out_file = open(opcode_file_path, 'w')
                    for i in opcodes:
                        out_file.write('%s\n' % i)
                    out_file.close()
            except AttributeError:
                print 'Error: %s' % apk_file_location
        else:
            print 'Exists: %s' % opcode_file_path


# main2()- with Androguard (better)
if __name__ == '__main__':
    main2()
